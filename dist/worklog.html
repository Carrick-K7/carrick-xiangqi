<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Team å·¥ä½œè®°å½•ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0f0f23;
      color: #e0e0e0;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px 40px;
      border-bottom: 1px solid #2d2d44;
    }
    
    .header h1 {
      font-size: 24px;
      background: linear-gradient(90deg, #00d4aa, #00a8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header .subtitle {
      font-size: 14px;
      color: #888;
      margin-top: 5px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 40px;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group label {
      font-size: 14px;
      color: #aaa;
    }
    
    select, input[type="date"], input[type="time"] {
      background: #1a1a2e;
      border: 1px solid #2d2d44;
      color: #e0e0e0;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    
    select:focus, input:focus {
      border-color: #00d4aa;
    }
    
    button {
      background: linear-gradient(135deg, #00d4aa 0%, #00a8ff 100%);
      border: none;
      color: #0f0f23;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button.secondary {
      background: #2d2d44;
      color: #e0e0e0;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid #2d2d44;
      padding-bottom: 10px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      transition: all 0.2s;
      color: #888;
    }
    
    .tab:hover {
      color: #e0e0e0;
      background: #1a1a2e;
    }
    
    .tab.active {
      color: #00d4aa;
      background: #1a1a2e;
      border-bottom: 2px solid #00d4aa;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    /* æ—¶é—´çº¿è§†å›¾ */
    .timeline {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #2d2d44;
    }
    
    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .timeline-grid {
      display: grid;
      grid-template-columns: 60px repeat(24, 1fr);
      gap: 2px;
    }
    
    .timeline-label {
      font-size: 12px;
      color: #666;
      text-align: right;
      padding-right: 10px;
      align-self: center;
    }
    
    .timeline-hour {
      aspect-ratio: 1;
      border-radius: 4px;
      background: #0f0f23;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .timeline-hour:hover {
      transform: scale(1.1);
      z-index: 10;
    }
    
    .timeline-hour.empty { background: #0f0f23; }
    .timeline-hour.low { background: rgba(0, 212, 170, 0.3); }
    .timeline-hour.medium { background: rgba(0, 212, 170, 0.6); }
    .timeline-hour.high { background: rgba(0, 212, 170, 0.9); }
    .timeline-hour.git { background: rgba(255, 107, 107, 0.7); }
    .timeline-hour.file { background: rgba(0, 168, 255, 0.7); }
    
    .timeline-legend {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      font-size: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    
    /* æˆå‘˜è§†å›¾ */
    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .member-card {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #2d2d44;
      transition: all 0.2s;
    }
    
    .member-card:hover {
      border-color: #00d4aa;
      transform: translateY(-2px);
    }
    
    .member-name {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 15px;
    }
    
    .member-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #00d4aa;
    }
    
    .stat-label {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }
    
    /* åˆ—è¡¨è§†å›¾ */
    .entries-list {
      background: #1a1a2e;
      border-radius: 12px;
      border: 1px solid #2d2d44;
      overflow: hidden;
    }
    
    .entry-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #2d2d44;
      transition: background 0.2s;
    }
    
    .entry-item:last-child {
      border-bottom: none;
    }
    
    .entry-item:hover {
      background: #252540;
    }
    
    .entry-time {
      width: 80px;
      font-size: 13px;
      color: #888;
      font-family: monospace;
    }
    
    .entry-type {
      width: 80px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      text-align: center;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .entry-type.task { background: rgba(0, 212, 170, 0.2); color: #00d4aa; }
    .entry-type.git { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .entry-type.file { background: rgba(0, 168, 255, 0.2); color: #00a8ff; }
    
    .entry-content {
      flex: 1;
      margin: 0 20px;
    }
    
    .entry-title {
      font-size: 14px;
      color: #e0e0e0;
    }
    
    .entry-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    .entry-member {
      width: 100px;
      text-align: right;
      font-size: 13px;
      color: #00d4aa;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #2d2d44;
      border-top-color: #00d4aa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty {
      text-align: center;
      padding: 60px;
      color: #666;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    /* ç»Ÿè®¡é¢æ¿ */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #2d2d44;
    }
    
    .stat-card.highlight {
      background: linear-gradient(135deg, #00d4aa20 0%, #00a8ff20 100%);
      border-color: #00d4aa40;
    }
    
    .stat-card-title {
      font-size: 13px;
      color: #888;
      margin-bottom: 10px;
    }
    
    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
    }
    
    .stat-card-change {
      font-size: 12px;
      margin-top: 8px;
    }
    
    .stat-card-change.positive { color: #00d4aa; }
    .stat-card-change.negative { color: #ff6b6b; }
    
    /* å“åº”å¼ */
    @media (max-width: 1024px) {
      .stats-panel {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        width: 100%;
      }
      
      select, input {
        flex: 1;
      }
      
      .stats-panel {
        grid-template-columns: 1fr;
      }
      
      .timeline-grid {
        grid-template-columns: 40px repeat(12, 1fr);
        gap: 1px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ¤– AI Team å·¥ä½œè®°å½•ç³»ç»Ÿ</h1>
    <div class="subtitle">100% çœŸå®å·¥ä½œæ•°æ®è¿½è¸ª | è‡ªåŠ¨é‡‡é›† SubAgent/Git/æ–‡ä»¶å˜æ›´</div>
  </header>
  
  <div class="container">
    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="stats-panel" id="statsPanel">
      <div class="stat-card highlight">
        <div class="stat-card-title">ä»Šæ—¥ä»»åŠ¡</div>
        <div class="stat-card-value" id="totalTasks">-</div>
        <div class="stat-card-change positive">å®æ—¶æ›´æ–°</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">Git æäº¤</div>
        <div class="stat-card-value" id="totalCommits">-</div>
        <div class="stat-card-change" id="commitsTrend">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">æ–‡ä»¶å˜æ›´</div>
        <div class="stat-card-value" id="totalFiles">-</div>
        <div class="stat-card-change" id="filesTrend">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">æ´»è·ƒæˆå‘˜</div>
        <div class="stat-card-value" id="activeMembers">-</div>
        <div class="stat-card-change" id="membersTrend">--</div>
      </div>
    </div>
    
    <!-- æ§åˆ¶æ  -->
    <div class="controls">
      <div class="control-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="dateSelect" />
      </div>
      <div class="control-group">
        <label>æˆå‘˜</label>
        <select id="memberSelect">
          <option value="">å…¨éƒ¨æˆå‘˜</option>
        </select>
      </div>
      <div class="control-group">
        <label>æ—¶é—´èŒƒå›´</label>
        <input type="time" id="startTime" value="00:00" />
        <span>è‡³</span>
        <input type="time" id="endTime" value="23:59" />
      </div>
      <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      <button class="secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡º</button>
    </div>
    
    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('timeline')">ğŸ“Š æ—¶é—´çº¿è§†å›¾</div>
      <div class="tab" onclick="switchTab('members')">ğŸ‘¥ æˆå‘˜è¯¦æƒ…</div>
      <div class="tab" onclick="switchTab('list')">ğŸ“ è¯¦ç»†åˆ—è¡¨</div>
    </div>
    
    <!-- æ—¶é—´çº¿è§†å›¾ -->
    <div class="view active" id="timelineView">
      <div class="timeline">
        <div class="timeline-header">
          <h3>24å°æ—¶å·¥ä½œåˆ†å¸ƒ</h3>
          <span style="color: #666; font-size: 14px;">æ‚¬åœæŸ¥çœ‹è¯¦æƒ…ï¼Œç‚¹å‡»ç­›é€‰æ—¶æ®µ</span>
        </div>
        <div class="timeline-grid" id="timelineGrid">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="timeline-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #0f0f23; border: 1px solid #2d2d44;"></div>
            <span>ç©ºé—²</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: rgba(0, 212, 170, 0.6);"></div>
            <span>SubAgent ä»»åŠ¡</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 107, 107, 0.7);"></div>
            <span>Git æäº¤</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: rgba(0, 168, 255, 0.7);"></div>
            <span>æ–‡ä»¶å˜æ›´</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æˆå‘˜è§†å›¾ -->
    <div class="view" id="membersView">
      <div class="members-grid" id="membersGrid">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- åˆ—è¡¨è§†å›¾ -->
    <div class="view" id="listView">
      <div class="entries-list" id="entriesList">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <script>
    // API åŸºç¡€åœ°å€
    const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:3456' : '';
    
    // çŠ¶æ€
    let currentDate = new Date().toISOString().split('T')[0];
    let currentMember = '';
    let currentData = null;
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('dateSelect').value = currentDate;
      loadMembers();
      refreshData();
    });
    
    // ç›‘å¬æ§ä»¶å˜åŒ–
    document.getElementById('dateSelect').addEventListener('change', (e) => {
      currentDate = e.target.value;
      refreshData();
    });
    
    document.getElementById('memberSelect').addEventListener('change', (e) => {
      currentMember = e.target.value;
      refreshData();
    });
    
    document.getElementById('startTime').addEventListener('change', refreshData);
    document.getElementById('endTime').addEventListener('change', refreshData);
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tab + 'View').classList.add('active');
    }
    
    // åŠ è½½æˆå‘˜åˆ—è¡¨
    async function loadMembers() {
      try {
        const res = await fetch(`${API_BASE}/api/work-logs/members?date=${currentDate}`);
        const data = await res.json();
        
        const select = document.getElementById('memberSelect');
        select.innerHTML = '<option value="">å…¨éƒ¨æˆå‘˜</option>';
        
        if (data.success && data.data.members) {
          data.data.members.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            select.appendChild(option);
          });
        }
      } catch (err) {
        console.error('Failed to load members:', err);
      }
    }
    
    // åˆ·æ–°æ•°æ®
    async function refreshData() {
      const start = document.getElementById('startTime').value;
      const end = document.getElementById('endTime').value;
      
      try {
        // åŠ è½½æ—¶é—´çº¿æ•°æ®
        const timelineRes = await fetch(
          `${API_BASE}/api/work-logs/timeline?date=${currentDate}&member=${currentMember}`
        );
        const timelineData = await timelineRes.json();
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        const statsRes = await fetch(
          `${API_BASE}/api/work-logs/query?date=${currentDate}&member=${currentMember}&start=${start}&end=${end}`
        );
        const statsData = await statsRes.json();
        
        currentData = {
          timeline: timelineData.success ? timelineData.data : null,
          entries: statsData.success ? statsData.data.entries : [],
        };
        
        updateStats(currentData.entries);
        renderTimeline(currentData.timeline);
        renderMembers();
        renderList(currentData.entries);
      } catch (err) {
        console.error('Failed to refresh:', err);
        showError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIæœåŠ¡æ˜¯å¦è¿è¡Œ');
      }
    }
    
    // æ›´æ–°ç»Ÿè®¡é¢æ¿
    function updateStats(entries) {
      const tasks = entries.filter(e => e.source === 'subagent');
      const commits = entries.filter(e => e.source === 'git');
      const files = entries.filter(e => e.source === 'filesystem');
      const members = [...new Set(entries.map(e => 
        e.member || e.author || 'unknown'
      ))];
      
      document.getElementById('totalTasks').textContent = tasks.length;
      document.getElementById('totalCommits').textContent = commits.length;
      document.getElementById('totalFiles').textContent = files.length;
      document.getElementById('activeMembers').textContent = members.length;
    }
    
    // æ¸²æŸ“æ—¶é—´çº¿
    function renderTimeline(data) {
      const grid = document.getElementById('timelineGrid');
      grid.innerHTML = '';
      
      if (!data || !data.hours) {
        grid.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
        return;
      }
      
      // æ ‡ç­¾è¡Œ
      grid.innerHTML += '<div class="timeline-label"></div>';
      for (let h = 0; h < 24; h++) {
        grid.innerHTML += `<div style="font-size: 10px; color: #666; text-align: center;">${h}</div>`;
      }
      
      // æ•°æ®è¡Œï¼ˆç®€åŒ–æ˜¾ç¤ºï¼Œå®é™…æŒ‰æˆå‘˜åˆ†ç»„ï¼‰
      grid.innerHTML += '<div class="timeline-label">å…¨å¤©</div>';
      data.hours.forEach(hour => {
        let className = 'timeline-hour empty';
        if (hour.entries.length > 0) {
          const hasGit = hour.entries.some(e => e.source === 'git');
          const hasFile = hour.entries.some(e => e.source === 'filesystem');
          const hasTask = hour.entries.some(e => e.source === 'subagent');
          
          if (hasGit) className = 'timeline-hour git';
          else if (hasFile) className = 'timeline-hour file';
          else if (hour.entries.length < 3) className = 'timeline-hour low';
          else if (hour.entries.length < 6) className = 'timeline-hour medium';
          else className = 'timeline-hour high';
        }
        
        const div = document.createElement('div');
        div.className = className;
        div.title = `${hour.time}: ${hour.entries.length} ä¸ªäº‹ä»¶`;
        div.onclick = () => {
          document.getElementById('startTime').value = hour.time;
          document.getElementById('endTime').value = `${String(hour.hour + 1).padStart(2, '0')}:00`;
          refreshData();
        };
        grid.appendChild(div);
      });
    }
    
    // æ¸²æŸ“æˆå‘˜è§†å›¾
    function renderMembers() {
      const grid = document.getElementById('membersGrid');
      
      if (!currentData || !currentData.entries.length) {
        grid.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘¥</div>æš‚æ— æˆå‘˜æ•°æ®</div>';
        return;
      }
      
      // æŒ‰æˆå‘˜åˆ†ç»„ç»Ÿè®¡
      const memberStats = {};
      currentData.entries.forEach(entry => {
        const member = entry.member || entry.author || 'unknown';
        if (!memberStats[member]) {
          memberStats[member] = { tasks: 0, commits: 0, files: 0, duration: 0 };
        }
        
        if (entry.source === 'subagent') {
          memberStats[member].tasks++;
          memberStats[member].duration += entry.duration || 0;
        } else if (entry.source === 'git') {
          memberStats[member].commits++;
        } else if (entry.source === 'filesystem') {
          memberStats[member].files++;
        }
      });
      
      grid.innerHTML = Object.entries(memberStats).map(([name, stats]) => `
        <div class="member-card" onclick="selectMember('${name}')">
          <div class="member-name">${name}</div>
          <div class="member-stats">
            <div class="stat">
              <div class="stat-value">${stats.tasks}</div>
              <div class="stat-label">ä»»åŠ¡</div>
            </div>
            <div class="stat">
              <div class="stat-value">${Math.round(stats.duration / 60)}</div>
              <div class="stat-label">åˆ†é’Ÿ</div>
            </div>
            <div class="stat">
              <div class="stat-value">${stats.commits}</div>
              <div class="stat-label">æäº¤</div>
            </div>
            <div class="stat">
              <div class="stat-value">${stats.files}</div>
              <div class="stat-label">æ–‡ä»¶</div>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // æ¸²æŸ“åˆ—è¡¨è§†å›¾
    function renderList(entries) {
      const list = document.getElementById('entriesList');
      
      if (!entries || entries.length === 0) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“</div>æš‚æ— è®°å½•</div>';
        return;
      }
      
      list.innerHTML = entries.map(entry => {
        const time = (entry.timestamp || entry.start_time || '').slice(11, 16);
        const member = entry.member || entry.author || 'system';
        
        let title = '';
        let meta = '';
        
        if (entry.source === 'subagent') {
          title = entry.task;
          meta = `çŠ¶æ€: ${entry.status} | æ—¶é•¿: ${Math.round((entry.duration || 0) / 60)}åˆ†é’Ÿ`;
        } else if (entry.source === 'git') {
          title = entry.message;
          meta = `ä»“åº“: ${entry.repo} | æ–‡ä»¶: ${entry.files?.length || 0}ä¸ª`;
        } else if (entry.source === 'filesystem') {
          title = entry.path.split('/').pop();
          meta = `æ“ä½œ: ${entry.change_type} | è·¯å¾„: ${entry.path}`;
        }
        
        return `
          <div class="entry-item">
            <div class="entry-time">${time}</div>
            <div class="entry-type ${entry.source === 'subagent' ? 'task' : entry.source === 'git' ? 'git' : 'file'}">
              ${entry.source === 'subagent' ? 'ä»»åŠ¡' : entry.source === 'git' ? 'Git' : 'æ–‡ä»¶'}
            </div>
            <div class="entry-content">
              <div class="entry-title">${title}</div>
              <div class="entry-meta">${meta}</div>
            </div>
            <div class="entry-member">${member}</div>
          </div>
        `;
      }).join('');
    }
    
    // é€‰æ‹©æˆå‘˜
    function selectMember(name) {
      document.getElementById('memberSelect').value = name;
      currentMember = name;
      refreshData();
      switchTab('list');
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.tab:nth-child(3)').classList.add('active');
    }
    
    // å¯¼å‡ºæ•°æ®
    function exportData() {
      if (!currentData) return;
      
      const dataStr = JSON.stringify(currentData.entries, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `worklog-${currentDate}${currentMember ? '-' + currentMember : ''}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // æ˜¾ç¤ºé”™è¯¯
    function showError(msg) {
      alert(msg);
    }
    
    // è‡ªåŠ¨åˆ·æ–°
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
