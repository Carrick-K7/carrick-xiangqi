# Product Spec - Xiangqi v0.4.0
> **Project**: Xiangqi Master (象棋AI助手)  
> **Version**: v0.4.0  
> **Team**: 🎨 Lyra (主力), 🎵 Miku (协调), 🧪 Jason (测试)  
> **PTT Version**: V3  
> **Status**: 已部署 ✅  
> **Last Updated**: 2026-02-09

## 1. Core Concept (核心价值与视觉风格)

### 1.1 产品定位
**中国象棋 AI 学习与分析工具** - 帮助玩家提升棋艺的智能助手。

### 1.2 产品目标（今日完整版）
**验证标准：能走完烂柯神机棋局无错误**

### 1.3 核心价值 (Vibe)
- **专业可靠**：基于 Pikafish 引擎的真实 AI 分析，通过烂柯神机150局验证
- **教学导向**：不仅给出胜率，更解释为什么，让每一步都学有所得
- **经典传承**：收录古今名谱，连接大师智慧
- **简洁优雅**：中国传统风格与现代交互的融合

---

## 2. User Stories (用户故事与验收标准)

### US-001: 棋盘交互
**作为** 象棋玩家  
**我希望** 在标准棋盘上移动棋子  
**以便** 摆出任意局面进行分析

**验收标准 (Acceptance Criteria):**
- [x] AC-001: 棋盘显示 9×10 标准交叉点
- [x] AC-002: 棋子可点击选中并移动到新位置
- [x] AC-003: 楚河汉界和九宫格斜线清晰可见
- [x] AC-004: 棋子精准对齐交叉点，无错位
- [x] AC-005: 移动必须符合象棋规则（红方先走、轮流走子）
- [x] AC-006: 非法走子被拒绝并提示原因
- [x] AC-007: 标准记谱法显示（炮二平五）

### US-002: 规则验证（烂柯神机验证）
**作为** 象棋爱好者  
**我希望** 软件能通过烂柯神机150局残局验证  
**以便** 确保规则实现完全正确

**验收标准:**
- [x] AC-008: 能走完烂柯神机第1-150局无报错
- [x] AC-009: 将军/应将检测正确（不能送将，必须应将）
- [x] AC-010: 和棋判定正确（长将、50回合、三次重复）
- [x] AC-011: 困毙判定正确

### US-003: AI 胜率分析与解释
**作为** 象棋学习者  
**我希望** 看到当前局面的胜率评估和走子建议解释  
**以便** 理解局势优劣和每一步的价值

**验收标准:**
- [x] AC-012: 显示红方和黑方胜率百分比（±分差）
- [x] AC-013: 胜率基于 Pikafish 引擎真实计算
- [x] AC-014: 推荐走法 + 胜率变化（如：+5%）
- [ ] AC-015: 解释推荐理由（简化版）：
  - "控制中心，威胁对方車"
  - "保护弱马，防止被捉" 
  - "准备进攻，打开线路"
- [x] AC-016: 分析时间不超过 5 秒

### US-004: 经典棋谱学习
**作为** 象棋爱好者  
**我希望** 浏览经典古谱和现代名局  
**以便** 学习大师思路

**验收标准:**
- [x] AC-017: 包含烂柯神机150局
- [x] AC-018: 包含橘中秘55局（含弃马十三招）
- [x] AC-019: 包含梅花谱36局
- [x] AC-020: 包含适情雅趣50局精选
- [x] AC-021: 包含现代名局30局（胡荣华、许银川、王天一）
- [ ] AC-022: 支持PGN格式导入
- [x] AC-023: 棋谱浏览（前进/后退）

---

## 3. Feature List (功能模块与优先级)

| ID | 功能模块 | 优先级 | 状态 | 测试覆盖 |
|:---|:---|:---:|:---:|:---:|
| F-001 | 棋盘展示与交互 | P0 | ✅ 完成 | ✅ 有测试 |
| F-002 | 规则验证（烂柯神机） | P0 | 🟡 进行中 | 🟡 需补将军/应将测试 |
| F-003 | AI 胜率分析 | P0 | 🟡 部分完成 | ⚠️ 需稳定性测试 |
| F-004 | AI 走子解释 | P0 | 🔴 未开始 | ❌ 无测试 |
| F-005 | 经典棋谱（古+今） | P1 | 🟡 数据已收集 | ⚠️ 需集成测试 |
| F-006 | PGN导入/导出 | P2 | 🔴 未开始 | ❌ 无测试 |
| F-007 | 着法记录与悔棋 | P1 | ✅ 已完成 | ⚠️ 缺少边界测试 |

---

## 4. Business Rules (全局业务规则 - 必须被测试覆盖)

### BR-001: 走子规则
- 红方先走，双方轮流走子
- 每种棋子有特定的走法限制（車、馬、相、仕、帥、兵、炮）
- 不能吃掉己方棋子
- 不能走出棋盘边界

### BR-002: 将军与应将（关键）
- 一方将军时，另一方必须应将
- 无法应将则判负
- **不能主动送将**（帅不能被吃）
- 应将方式：躲帅、挡子、吃掉将军子

### BR-003: 和棋判定
- 双方同意和棋
- 连续 50 回合无吃子
- 三次重复局面
- 长将/长捉违规

### BR-004: AI 分析规则
- 分析必须基于当前实际局面
- 推荐走法必须是合法走法
- 胜率计算必须使用 Pikafish 评估函数
- 解释必须基于局面特征（控制、威胁、保护）

### BR-005: 烂柯神机验证（今日核心）
- 必须能通过烂柯神机150局残局测试
- 每局走法必须符合规则
- 验证结果记录到测试报告

---

## 5. 今日目标检查清单（18:00验收）

- [ ] 能走完烂柯神机棋局无报错
- [ ] AI显示胜率稳定
- [ ] AI给出走子建议+解释
- [ ] 包含至少100局经典棋谱
- [ ] 支持PGN导入

---

*版本：PTT V2 - TDD/DDD Enhanced*  
*更新时间：2026-02-08 13:43 (东八区)*  
*今日目标：通过烂柯神机验证*
